<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Task Review AI - Live Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --border-light: #e2e8f0;
            --border-dark: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        body.dark {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark .header {
            background: rgba(30, 41, 59, 0.95);
        }

        .title {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #64748b;
            margin-top: 5px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-badge.online {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        body.dark .card {
            background: rgba(30, 41, 59, 0.95);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
        }

        body.dark label {
            color: var(--text-dark);
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        body.dark input,
        body.dark textarea,
        body.dark select {
            background: var(--card-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .results {
            margin-top: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
        }

        body.dark .results {
            background: rgba(15, 23, 42, 0.5);
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body.dark .metric {
            background: var(--card-dark);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .metric-label {
            color: #64748b;
            margin-top: 5px;
        }

        .status-header {
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .status-pass {
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .status-borderline {
            color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .status-fail {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-light);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        body.dark .progress-bar {
            background: var(--border-dark);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.5s ease;
        }

        .analysis-item {
            margin: 15px 0;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .file-input {
            padding: 10px;
            border: 2px dashed var(--border-light);
            background: rgba(99, 102, 241, 0.05);
        }

        body.dark .file-input {
            border-color: var(--border-dark);
            background: rgba(99, 102, 241, 0.1);
        }

        .file-input:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .tts-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .tts-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tts-btn {
            padding: 10px 20px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tts-btn:hover:not(:disabled) {
            background: #059669;
            transform: scale(1.05);
        }

        .tts-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        .file-name {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 6px;
            font-size: 0.9em;
            color: var(--primary);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 class="title">üõ°Ô∏è Task Review AI</h1>
                <p class="subtitle">Deterministic Engineering Task Analysis System</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåô</button>
                <div class="status-badge" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Checking...</span>
                </div>
            </div>
        </div>

        <div class="card">
            <form id="taskForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label for="scenario">Select Scenario</label>
                    <select id="scenario" onchange="loadScenario()">
                        <option value="live">Live Editor</option>
                        <option value="good">Good Submission</option>
                        <option value="partial">Partial Submission</option>
                        <option value="poor">Poor Submission</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">Task Title</label>
                    <input type="text" id="title" placeholder="Enter task title..." required>
                </div>

                <div class="form-group">
                    <label for="description">Task Description</label>
                    <textarea id="description" rows="8" placeholder="Enter detailed task description..."
                        required></textarea>
                </div>

                <div class="form-group">
                    <label for="github">GitHub Repository URL (Optional)</label>
                    <input type="text" id="github" placeholder="https://github.com/user/repo">
                </div>

                <div class="form-group">
                    <label for="pdfFile">üìÑ Project Documentation (PDF - Optional)</label>
                    <input type="file" id="pdfFile" accept=".pdf" class="file-input" onchange="handleFileSelect(event)">
                    <span id="fileName" class="file-name" style="display: none;"></span>
                </div>

                <div class="form-group">
                    <label for="name">Your Name</label>
                    <input type="text" id="name" value="Demo Professional" required>
                </div>

                <button type="submit" class="btn" id="submitBtn">
                    Analyze Submission
                </button>
            </form>

            <div id="error" class="error" style="display: none;"></div>
            <div id="results" style="display: none;"></div>

            <!-- TTS Section -->
            <div id="ttsSection" class="tts-section" style="display: none;">
                <h3 style="margin-bottom: 15px;">üîä Text-to-Speech</h3>
                <div class="tts-controls">
                    <button class="tts-btn" onclick="speakResults()" id="ttsBtn">
                        üé§ Speak Results
                    </button>
                    <select id="ttsLanguage"
                        style="padding: 10px; border-radius: 8px; border: 2px solid var(--border-light);">
                        <option value="en">English</option>
                        <option value="hi">Hindi</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div id="audioPlayer" style="display: none; margin-top: 15px;">
                    <audio id="ttsAudio" controls></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect backend URL based on environment
        const BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api/v1/task'
            : `${window.location.origin}/api/v1/task`;

        const TTS_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api/v1/tts'
            : `${window.location.origin}/api/v1/tts`;

        console.log('üåê Backend URL:', BACKEND_URL);
        console.log('üîä TTS URL:', TTS_URL);

        const scenarios = {
            live: { title: '', desc: '', github: '' },
            good: {
                title: 'Enterprise-Grade Distributed Task Processing System with Resilience and Monitoring',
                desc: 'Objective: To architect and implement a horizontally scalable task processing engine. Requirements include high availability via multi-node deployments, failure resilience using exponential backoff with dead-letter queues, and real-time observability. The goal is to ensure 99.9% uptime by utilizing production-grade monitoring suites like Prometheus and Grafana. This requirement covers security constraints for mTLS and internal authentication. The purpose is to handle high-throughput workloads with sub-50ms latency while maintaining full database consistency across shards. Performance optimization is achieved through efficient connection pooling and asynchronous execution patterns. Final success criteria: 100% test coverage and full audit logging.',
                github: 'https://github.com/fastapi/fastapi'
            },
            partial: {
                title: 'Standard API Implementation for Basic Data Operations and Storage',
                desc: 'Requirement: The objective is to build an API that connects to a SQL database. It should handle GET and POST requests for user data. Some security constraints like basic auth should be added eventually. The purpose is to make the system work for the initial release. We need to handle basic database connections and ensure some error handling is present in the main controller.',
                github: 'https://github.com/encode/uvicorn'
            },
            poor: {
                title: 'Fix fast',
                desc: 'fix the bugs in the code quickly. make it run without error. just get it done today.',
                github: ''
            }
        };

        // Check backend health on load
        checkBackendHealth();

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.querySelector('.theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark') {
            toggleTheme();
        }

        async function checkBackendHealth() {
            try {
                const response = await fetch(BACKEND_URL.replace('/api/v1/task', '/health'));
                if (response.ok) {
                    document.getElementById('statusBadge').className = 'status-badge online';
                    document.getElementById('statusText').textContent = 'Backend Online';
                } else {
                    throw new Error('Backend offline');
                }
            } catch (error) {
                document.getElementById('statusBadge').className = 'status-badge offline';
                document.getElementById('statusText').textContent = 'Backend Offline';
            }
        }

        function loadScenario() {
            const scenario = document.getElementById('scenario').value;
            const data = scenarios[scenario];
            document.getElementById('title').value = data.title;
            document.getElementById('description').value = data.desc;
            document.getElementById('github').value = data.github;
            document.getElementById('pdfFile').value = '';
            document.getElementById('fileName').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('ttsSection').style.display = 'none';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileNameSpan = document.getElementById('fileName');
            if (file) {
                fileNameSpan.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileNameSpan.style.display = 'inline-block';
            } else {
                fileNameSpan.style.display = 'none';
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const errorDiv = document.getElementById('error');
            const resultsDiv = document.getElementById('results');
            const ttsSection = document.getElementById('ttsSection');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Analyzing...';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            ttsSection.style.display = 'none';

            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('github_url', document.getElementById('github').value);
            formData.append('submitted_by', document.getElementById('name').value);

            // Add PDF file if selected
            const pdfFile = document.getElementById('pdfFile').files[0];
            if (pdfFile) {
                formData.append('pdf_file', pdfFile);
            }

            try {
                const response = await fetch(`${BACKEND_URL}/review`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayResults(data);

                // Show TTS section after results
                ttsSection.style.display = 'block';
            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Analyze Submission';
            }
        }

        let currentResults = null;

        async function speakResults() {
            if (!currentResults) {
                alert('No results to speak!');
                return;
            }

            const ttsBtn = document.getElementById('ttsBtn');
            const language = document.getElementById('ttsLanguage').value;
            const audioPlayer = document.getElementById('audioPlayer');
            const audioElement = document.getElementById('ttsAudio');

            ttsBtn.disabled = true;
            ttsBtn.innerHTML = '<span class="spinner"></span> Generating Speech...';

            try {
                // Create summary text from results
                const summaryText = `Task Review Results. Status: ${currentResults.status}. Score: ${currentResults.score} out of 100. Readiness: ${currentResults.readiness_percent} percent. Technical Quality: ${currentResults.analysis.technical_quality} percent. Clarity: ${currentResults.analysis.clarity} percent. Discipline Signals: ${currentResults.analysis.discipline_signals} percent.`;

                const response = await fetch(`${TTS_URL}/speak`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: summaryText,
                        language: language,
                        mode: 'stream'
                    })
                });

                if (!response.ok) {
                    throw new Error(`TTS failed: ${response.statusText}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                audioElement.src = audioUrl;
                audioPlayer.style.display = 'block';
                audioElement.play();

            } catch (error) {
                alert(`TTS Error: ${error.message}`);
            } finally {
                ttsBtn.disabled = false;
                ttsBtn.innerHTML = 'üé§ Speak Results';
            }
        }

        function displayResults(data) {
            currentResults = data;
            const resultsDiv = document.getElementById('results');
            const statusClass = `status-${data.status}`;

            resultsDiv.innerHTML = `
                <div class="status-header ${statusClass}">
                    Status: ${data.status.toUpperCase()}
                </div>
                
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value">${data.score}/100</div>
                        <div class="metric-label">Score</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${data.readiness_percent}%</div>
                        <div class="metric-label">Readiness</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${data.meta.evaluation_time_ms}ms</div>
                        <div class="metric-label">Eval Time</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Technical Analysis</h3>
                
                <div class="analysis-item">
                    <div class="analysis-header">
                        <span>Technical Quality (Repo)</span>
                        <span>${data.analysis.technical_quality}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.analysis.technical_quality}%"></div>
                    </div>
                </div>

                <div class="analysis-item">
                    <div class="analysis-header">
                        <span>Clarity (Description)</span>
                        <span>${data.analysis.clarity}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.analysis.clarity}%"></div>
                    </div>
                </div>

                <div class="analysis-item">
                    <div class="analysis-header">
                        <span>Discipline Signals (PDF)</span>
                        <span>${data.analysis.discipline_signals}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.analysis.discipline_signals}%"></div>
                    </div>
                </div>

                ${data.failure_reasons && data.failure_reasons.length > 0 ? `
                    <div style="margin-top: 25px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 10px;">
                        <h3 style="color: var(--danger); margin-bottom: 10px;">‚ùå Failure Reasons</h3>
                        <ul style="margin-left: 20px;">
                            ${data.failure_reasons.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${data.improvement_hints && data.improvement_hints.length > 0 ? `
                    <div style="margin-top: 25px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px;">
                        <h3 style="color: var(--success); margin-bottom: 10px;">‚ú® Optimization Hints</h3>
                        <ul style="margin-left: 20px;">
                            ${data.improvement_hints.map(h => `<li>${h}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${data.next_task ? `
                    <div style="margin-top: 25px; padding: 20px; background: rgba(99, 102, 241, 0.1); border-radius: 10px;">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">üí° Recommended Next Step</h3>
                        <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">${data.next_task.title}</p>
                        <p><strong>Objective:</strong> ${data.next_task.objective}</p>
                        <p><strong>Focus:</strong> ${data.next_task.focus_area}</p>
                    </div>
                ` : ''}
            `;

            resultsDiv.style.display = 'block';
        }
    </script>
</body>

</html>